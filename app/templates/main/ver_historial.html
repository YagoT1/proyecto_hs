{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-900 text-gray-100 p-6 flex flex-col items-center">
    <div class="max-w-4xl w-full bg-gray-800 p-8 rounded-lg shadow-xl mb-8">
        <h1 class="text-4xl font-extrabold text-center text-blue-400 mb-6">Seleccionar Período de Historial</h1>
        <p class="text-center text-gray-300 mb-8">Elige el mes y año para ver los registros de horas.</p>

        <!-- Mensajes Flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mt-4 space-y-3">
                    {% for category, message in messages %}
                        <div class="p-3 rounded-md text-sm {% if category == 'success' %}bg-green-500 text-white{% elif category == 'danger' %}bg-red-500 text-white{% elif category == 'info' %}bg-blue-500 text-white{% else %}bg-gray-500 text-white{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Formulario de Selección de Mes/Año -->
        <form action="{{ url_for('main.mostrar_historial_detallado', year=selected_year, month=selected_month) }}" method="GET" class="flex flex-col items-center gap-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}"> {# CSRF token, aunque GET no lo requiere estrictamente, es buena práctica si el form pudiera ser POST #}
            
            <div class="flex items-center gap-4">
                <label for="month-year-select" class="text-lg font-medium text-gray-300">Período:</label>
                <select id="month-year-select" 
                        name="periodo" {# Importante: añadir un atributo 'name' para que el valor se envíe en el formulario #}
                        class="block w-auto px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    {% for month_data in available_months %}
                        <option value="{{ month_data.year }}/{{ month_data.month }}" {# Formato year/month para enviar #}
                                {% if month_data.year == selected_year and month_data.month == selected_month %}selected{% endif %}>
                            {{ month_data.display_name }}
                        </option>
                    {% else %}
                        <option value="" disabled>No hay meses disponibles</option>
                    {% endfor %}
                </select>
            </div>

            <button type="submit" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <i class="fas fa-eye mr-2"></i> Ver Historial
            </button>
        </form>

        <div class="mt-8 text-center">
            <a href="{{ url_for('main.index') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                <i class="fas fa-arrow-left mr-2"></i> Volver al Dashboard
            </a>
        </div>
    </div>
</div>

<script>
    // Script para manejar la selección del periodo y actualizar la URL del formulario
    document.addEventListener('DOMContentLoaded', function() {
        const selectElement = document.getElementById('month-year-select');
        const formElement = selectElement.closest('form'); // Encuentra el formulario más cercano

        if (selectElement && formElement) {
            selectElement.addEventListener('change', function() {
                const selectedValue = this.value; // Formato "year/month"
                const parts = selectedValue.split('/');
                const year = parts[0];
                const month = parts[1];
                
                // Actualiza la acción del formulario para que apunte a la ruta correcta
                // Esto es importante porque el valor del select se envía como 'periodo',
                // pero la ruta necesita 'year' y 'month' como parámetros de URL.
                // Podríamos usar JavaScript para hacer la redirección directamente,
                // pero el usuario pidió un botón de confirmar, así que actualizamos la acción.
                formElement.action = "{{ url_for('main.mostrar_historial_detallado', year=0, month=0) }}".replace('/0/0', `/${year}/${month}`);
            });

            // Asegurarse de que la acción del formulario esté correcta al cargar la página
            // para el valor seleccionado inicialmente (que viene de Flask)
            const initialSelectedOption = selectElement.options[selectElement.selectedIndex];
            if (initialSelectedOption) {
                const initialValue = initialSelectedOption.value;
                const parts = initialValue.split('/');
                const year = parts[0];
                const month = parts[1];
                formElement.action = "{{ url_for('main.mostrar_historial_detallado', year=0, month=0) }}".replace('/0/0', `/${year}/${month}`);
            }
        }
    });
</script>
{% endblock content %}
